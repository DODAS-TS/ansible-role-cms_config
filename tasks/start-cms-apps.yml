---

- name: Create groups and dependencies
  run_once: true
  uri: 
     url: "{{marathon_protocol}}://marathon.service.consul:{{marathon_port}}/v2/groups"
     user: "{{marathon_username}}"
     password: "{{marathon_password}}"
     validate_certs: "no"
     ##
     # PUT is needed because POST is for new groupt but
     # we are extending '/', that already exists
     # With method POST we will receive error 409:
     # Group is already created. Use PUT to change this group
     method: PUT
     HEADER_Content-Type: "application/json"
     body: "{{ lookup('template', 'templates/application_groups.json') }}"
     body_format: json
  register: result
  until: result.status == 200
  retries: 10
  delay: 20
  changed_when: false
  tags:
    - cms_apps

- name: start CMS squid
  run_once: true
  uri: 
     url: "{{marathon_protocol}}://marathon.service.consul:{{marathon_port}}/v2/apps"
     user: "{{marathon_username}}"
     password: "{{marathon_password}}"
     validate_certs: "no"
     method: POST
     HEADER_Content-Type: "application/json"
     body: "{{ lookup('template', 'templates/cmssquid-app.json') }}"
     body_format: json
  register: result
  # The application has been created and a deployment is started.
  until: result.status == 201
  retries: 10
  delay: 20
  changed_when: false
  tags:
    - cms_apps

- name: wait for cms squid to be up and running 
  wait_for: 
     host: "{{cms_config_mysquid_host}}" 
     port: "{{cms_config_mysquid_port}}"
     delay: 20
     timeout: 600
     connect_timeout: 10
  tags:
    - cms_apps

- name: start CMS proxy cache
  run_once: true
  uri: 
     url: "{{marathon_protocol}}://marathon.service.consul:{{marathon_port}}/v2/apps"
     user: "{{marathon_username}}"
     password: "{{marathon_password}}"
     validate_certs: "no"
     method: POST
     HEADER_Content-Type: "application/json"
     body: "{{ lookup('template', 'templates/cmsproxycache-app.json') }}"
     body_format: json
  register: result
  # The application has been created and a deployment is started.
  until: result.status == 201
  retries: 10
  delay: 20
  changed_when: false
  tags:
    - cms_apps

- name: wait for cms proxy cache service to be up and running 
  wait_for:
     host: "{{cms_config_proxycache_host}}"
     port: "{{cms_config_proxycache_serviceport}}"
     delay: 20
     timeout: 600
     connect_timeout: 10
  tags:
    - cms_apps

- name: start CMS cvmfs check
  run_once: true
  uri: 
     url: "{{marathon_protocol}}://marathon.service.consul:{{marathon_port}}/v2/apps"
     user: "{{marathon_username}}"
     password: "{{marathon_password}}"
     validate_certs: "no"
     method: POST
     HEADER_Content-Type: "application/json"
     body: "{{ lookup('template', 'templates/cvmfskeepalive-app.json') }}"
     body_format: json
  register: result
  # The application has been created and a deployment is started.
  until: result.status == 201
  retries: 10
  delay: 20
  changed_when: false
  tags:
    - cms_apps

- name: start CMS WN CentOS6
  run_once: true
  uri:
     url: "{{marathon_protocol}}://marathon.service.consul:{{marathon_port}}/v2/apps"
     user: "{{marathon_username}}"
     password: "{{marathon_password}}"
     validate_certs: "no"
     method: POST
     HEADER_Content-Type: "application/json"
     body: "{{ lookup('template', 'templates/cmswn-app.json') }}"
     body_format: json
  register: result
  # The application has been created and a deployment is started.
  until: result.status == 201
  retries: 10
  delay: 20
  changed_when: false
  tags:
    - cms_apps

- name: start CMS WN CentOS7
  run_once: true
  uri:
     url: "{{marathon_protocol}}://marathon.service.consul:{{marathon_port}}/v2/apps"
     user: "{{marathon_username}}"
     password: "{{marathon_password}}"
     validate_certs: "no"
     method: POST
     HEADER_Content-Type: "application/json"
     body: "{{ lookup('template', 'templates/cmswnel7-app.json') }}"
     body_format: json
  register: result
  # The application has been created and a deployment is started.
  until: result.status == 201
  retries: 10
  delay: 20
  changed_when: false
  tags:
    - cms_apps
